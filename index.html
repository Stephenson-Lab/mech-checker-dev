<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dr Stephenson’s Mech-Checker</title>

  <!-- Define JSME callback FIRST -->
  <script>
    function jsmeOnLoad() {
      window.jsmeApplet = new JSApplet.JSME("jsme_container", "520px", "380px");
      if (typeof initializePage === "function") {
        initializePage();
      }
    }
  </script>

  <!-- JSME hosted version -->
  <script src="https://jsme-editor.github.io/dist/jsme/jsme.nocache.js"></script>

  <!-- OpenChemLib -->
  <script src="https://unpkg.com/openchemlib@8.3.0/dist/openchemlib-full.js"></script>

  <!-- Your task data -->
  <script src="./tasks.js"></script>

  <style>
  body {
    font-family: system-ui, Arial, sans-serif;
    margin: 20px;
  }

  .wrap {
    max-width: 1000px;
    margin: auto;
  }

  .card {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 20px;
  }

  .row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }

  .col {
    flex: 1 1 400px;
  }

  button {
    padding: 10px 16px;
    border-radius: 8px;
    border: 2px solid #800000;
    background: #fff;
    cursor: pointer;
  }

  button:hover {
    background: #EAEAEA;
  }

  .msg {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    white-space: pre-wrap;
  }
    
  #prompt {
    white-space: pre-wrap;
  }
    
  .muted {
    opacity: 0.8;
  }

  .task-title {
    margin-top: 0;
    margin-bottom: 16px;
    color: #8B0000;
    font-weight: 600;
  }

  /* Logo header styling */
  .header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 10;
  }

  .logo {
    height: 165px;
    width: auto;
    display: block;
  }
</style>

  <script>
    let currentTask = null;

    function getTaskId() {
      // Try query string first: ?task=2
      const qs = new URLSearchParams(window.location.search);
      let raw = qs.get("task");

      // Fallback to hash: #task=2  (or #task=2&x=y)
      if (!raw && window.location.hash) {
        const h = window.location.hash.replace(/^#/, "");
        const hs = new URLSearchParams(h);
        raw = hs.get("task");
      }

      const n = Number(raw);
      if (Number.isInteger(n) && window.TASKS && window.TASKS[n]) return n;
      return 1;
    }

    function initializePage() {
      const taskId = getTaskId();
      currentTask = window.TASKS[taskId];

      document.getElementById("title").textContent = currentTask.title;
      document.getElementById("formula").textContent = currentTask.formula;
      document.getElementById("prompt").textContent = currentTask.prompt || "";
      document.getElementById("stereoReq").textContent =
        currentTask.requireStereo ? "Required" : "Ignored";
    }

    function clearDrawing() {
      window.jsmeApplet.readMolFile("");
      document.getElementById("msg").style.display = "none";
    }

    function showMsg(text) {
      const el = document.getElementById("msg");
      el.style.display = "block";
      el.textContent = text;
    }

    function checkAnswer() {
      if (!currentTask) return;

      const smiles = window.jsmeApplet.smiles().trim();
      if (!smiles) {
        showMsg("Draw a structure first.");
        return;
      }

      let studentMol;
      try {
        studentMol = OCL.Molecule.fromSmiles(smiles);
      } catch (e) {
        showMsg("Could not read that structure. Try again.");
        return;
      }

      const studentFormula = studentMol.getMolecularFormula().formula;
      if (studentFormula !== currentTask.formula) {
        showMsg(
          "Formula mismatch.\nYou drew: " +
          studentFormula +
          "\nExpected: " +
          currentTask.formula
        );
        return;
      }

      const studentID_stereo =
        OCL.CanonizerUtil.getIDCode(studentMol, OCL.CanonizerUtil.NORMAL);
      const studentID_noStereo =
        OCL.CanonizerUtil.getIDCode(studentMol, OCL.CanonizerUtil.NOSTEREO);

      const acceptableStereo = new Set(
        currentTask.answersSmiles.map(s =>
          OCL.CanonizerUtil.getIDCode(
            OCL.Molecule.fromSmiles(s),
            OCL.CanonizerUtil.NORMAL
          )
        )
      );

      const acceptableNoStereo = new Set(
        currentTask.answersSmiles.map(s =>
          OCL.CanonizerUtil.getIDCode(
            OCL.Molecule.fromSmiles(s),
            OCL.CanonizerUtil.NOSTEREO
          )
        )
      );

      if (currentTask.requireStereo) {
        if (acceptableStereo.has(studentID_stereo)) {
          showMsg("✅ Correct!");
        } else if (acceptableNoStereo.has(studentID_noStereo)) {
          showMsg("❌ Right connectivity, but stereochemistry is wrong or missing.");
        } else {
          showMsg("❌ Incorrect. Check connectivity / regiochemistry / stereochemistry.");
        }
      } else {
        if (acceptableNoStereo.has(studentID_noStereo)) {
          showMsg("✅ Correct! (Stereochemistry ignored for this task.)");
        } else {
          showMsg("❌ Incorrect. Check connectivity / regiochemistry.");
        }
      }
    }
  </script>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <img src="./assets/logo.png" alt="Dr Stephenson's Mech-Checker" class="logo">
    </div>
    
    <div class="card">
      <h2 id="title" class="task-title" style="margin-top:0;"></h2>
      
      <div class="row">
        <div class="col">
          <p><b>Formula:</b> <span id="formula"></span></p>
          <p><b>Stereochemistry:</b> <span id="stereoReq"></span></p>
          <p id="prompt" class="muted"></p>
        </div>

        <div class="col">
          <div id="jsme_container"></div>

          <div style="margin-top:12px; display:flex; gap:10px;">
            <button onclick="checkAnswer()">Check</button>
            <button onclick="clearDrawing()">Clear</button>
          </div>

          <div id="msg" class="msg" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
